<form [formGroup]="form" *ngIf="form">
  <ion-list class="payment-method">
    <ion-item lines="none">
      <ion-label>Valor da compra</ion-label>
      <ion-button fill="clear" color="success" slot="end">
        {{totalPrice | currency: "R$ "}}
      </ion-button>
    </ion-item>
    <ion-item lines="none" *ngIf="deliveryPrice" test-id="delivery-price">
      <ion-label>Entrega</ion-label>
      <ion-button fill="clear" color="success" slot="end">
        {{deliveryPrice | currency: "R$ "}}
      </ion-button>
    </ion-item>
    <ion-item lines="none">
      <ion-label>Valor total</ion-label>
      <ion-button fill="clear" color="success" slot="end">
        {{totalPrice + (deliveryPrice || 0) | currency: "R$ "}}
      </ion-button>
    </ion-item>
  </ion-list>

  <ion-list>
    <ion-radio-group formControlName="paymentType">
      <ion-item>
        <ion-label>PIX</ion-label>
        <ion-radio slot="start" [value]="PaymentType.PIX"></ion-radio>
      </ion-item>
      <ion-item *ngIf="!address || address?.city === company?.address?.city" test-id="money">
        <ion-label>Dinheiro (ao receber produto)</ion-label>
        <ion-radio slot="start" [value]="PaymentType.MONEY"></ion-radio>
      </ion-item>
      <ion-item *ngIf="company?.payment?.creditCard" test-id="credit-card">
        <ion-label>Cartão de crédito</ion-label>
        <ion-radio slot="start" [value]="PaymentType.CREDIT_CARD"></ion-radio>
      </ion-item>
    </ion-radio-group>
  </ion-list>

  <ion-card *ngIf="form.value.paymentType === 'PIX'" (click)="copyPix()" test-id="pix-key">
    <ion-card-header>
      <ion-card-title>Chave PIX</ion-card-title>
      <ion-card-subtitle>
        <ion-skeleton-text *ngIf="!company?.payment?.pixKey" [animated]="true"></ion-skeleton-text>
        <span *ngIf="company?.payment?.pixKey">{{company.payment.pixKey}}</span>
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content align="right">* Clique para copiar</ion-card-content>
  </ion-card>

  <span *ngIf="form.value.paymentType === 'CREDIT_CARD'">
    <ion-card test-id="credit-card-form">
      <ion-card-header>
        <ion-card-title>Dados do Cartão</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list formGroupName="creditCard">
          <ion-item>
            <ion-label position="floating">Tipo</ion-label>
            <ion-select formControlName="cardFlag">
              <ion-select-option *ngFor="let flag of company.payment.creditCard.flags" [value]="flag">
                {{flag}}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Número do cartão</ion-label>
            <ion-input type="tel" formControlName="cardNumber"
              [brmasker]="{mask:'0000   0000   0000   0000', len:25}">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Nome do titular</ion-label>
            <ion-input formControlName="cardHolder"></ion-input>
          </ion-item>
          <div class="card-numbers">
            <ion-item>
              <ion-label position="floating">Mês</ion-label>
              <ion-input type="tel" formControlName="cardMonth" [brmasker]="{mask:'00', len:2}"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="floating">Ano</ion-label>
              <ion-input type="tel" formControlName="cardYear" [brmasker]="{mask:'0000', len:4}"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="floating">CVV</ion-label>
              <ion-input type="tel" formControlName="cardCvc" [brmasker]="{mask:'000', len:3}"></ion-input>
            </ion-item>
          </div>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card test-id="billing-address">
      <ion-card-header>
        <ion-card-title>Endereço de cobrança</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list formGroupName="billingAddress">
          <ion-item>
            <ion-label position="floating">Logradouro</ion-label>
            <ion-input type="tel" formControlName="street">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Número</ion-label>
            <ion-input type="tel" formControlName="number">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Bairro</ion-label>
            <ion-input type="tel" formControlName="neighborhood">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">CEP</ion-label>
            <ion-input type="tel" formControlName="zipCode" [brmasker]="{mask:'00.000-000', len:10}">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Cidade</ion-label>
            <ion-input type="tel" formControlName="city">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Estado*</ion-label>
            <ion-select formControlName="state">
              <ion-select-option *ngFor="let state of states" [value]="state.code">
                {{state.name}}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </span>

  <div class="ion-padding">
    <ion-button size="full" (click)="finishPurchase()" *ngIf="form.value.paymentType !== 'PIX'"
      test-id="finish-purchase-button">
      Finalizar pedido
    </ion-button>
    <ion-button size="full" *ngIf="form.value.paymentType === 'PIX'" test-id="receipt-button">
      <input type="file" (change)="uploadReceipt($event)" accept=".png, .jpg, .pdf"/>
      Enviar comprovante
    </ion-button>
  </div>
</form>